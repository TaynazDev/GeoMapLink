<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clickmap - Interactive World Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            zoom: 1;
            margin: 0;
            padding: 0;
        }

        .top-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 50%, transparent 100%);
            z-index: 1001;
            pointer-events: nonenow ;
        }

        .logo {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            pointer-events: none;
        }

        .logo h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            font-family: 'Inter', sans-serif;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            letter-spacing: -0.02em;
        }

        #map-container {
            flex: 1;
            position: relative;
            background: white;
            border-radius: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        svg {
            display: block;
            width: 100%;
            height: 100%;
            flex: 1;
        }

        .ocean {
            fill: #1e3a5f;
            pointer-events: none;
        }

        .latitude-line {
            fill: none;
            stroke: #374151;
            stroke-width: 0.5;
            stroke-dasharray: 5, 5;
            opacity: 0.4;
            pointer-events: none;
        }

        .latitude-line.equator {
            stroke: #4b5563;
            stroke-width: 1;
            opacity: 0.5;
        }

        .latitude-label {
            fill: #6b7280;
            font-size: 9px;
            font-weight: 500;
            opacity: 0.6;
            pointer-events: none;
        }

        .timezone-boundary {
            fill: none;
            stroke: #374151;
            stroke-width: 0.3;
            opacity: 0.2;
            pointer-events: none;
        }

        .timezone-label {
            fill: #6b7280;
            font-size: 7px;
            font-weight: 400;
            opacity: 0.4;
            pointer-events: none;
            text-anchor: middle;
        }

        .country {
            fill: #2d3748;
            stroke: #1a1d2e;
            stroke-width: 0.5;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .country:hover {
            fill: #fbbf24;
            stroke: #f59e0b;
            stroke-width: 1;
        }

        .country.active {
            fill: #fbbf24;
            stroke: #f59e0b;
            stroke-width: 1.5;
        }

        .country-label {
            fill: #e5e7eb;
            font-size: 7px;
            font-weight: 600;
            pointer-events: none;
            text-shadow: 
                1px 1px 2px rgba(0, 0, 0, 0.9),
                -1px -1px 2px rgba(0, 0, 0, 0.9),
                1px -1px 2px rgba(0, 0, 0, 0.9),
                -1px 1px 2px rgba(0, 0, 0, 0.9);
            opacity: 0.8;
        }
        
        .country-label-small {
            font-size: 5px;
        }

        .search-sidebar {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 320px;
            background: #f8f9fa;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1003;
            display: flex;
            flex-direction: column;
            border-radius: 0;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .search-sidebar.visible {
            transform: translateX(0);
        }

        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .search-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .search-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem;
            padding-top: 4rem;
            color: white;
        }

        .search-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 2px 12px rgba(102, 126, 234, 0.3);
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .search-result-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .search-result-item:hover {
            background: #667eea;
            color: white;
            transform: translateX(4px);
        }

        .result-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .result-type {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .info-panel {
            position: relative;
            width: 380px;
            background: white;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border-radius: 0;
        }

        .city-selector {
            margin-bottom: 1.5rem;
        }

        .city-selector label {
            display: block;
            color: #718096;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .city-dropdown {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .city-dropdown:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem;
            padding-top: 4rem;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .panel-content {
            padding: 1.5rem;
            flex: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .flag-container {
            width: 60px;
            height: 40px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
        }

        .flag-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .country-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            line-height: 1.2;
        }

        .weather-widget {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .weather-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .weather-icon {
            font-size: 5rem;
            line-height: 1;
            margin-bottom: 1rem;
            text-align: center;
        }

        .weather-condition {
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0.95;
        }

        .weather-temp {
            font-size: 3.5rem;
            font-weight: 300;
            line-height: 1;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .weather-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .weather-detail-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .weather-detail-value {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px solid #f7fafc;
        }

        .info-row:last-of-type {
            border-bottom: none;
        }

        .info-label {
            color: #718096;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .info-value {
            color: #2d3748;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: right;
        }

        .learn-more-btn {
            display: inline-block;
            width: 100%;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            pointer-events: auto;
        }

        .learn-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .controls {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row;
            gap: 4px;
            z-index: 1002;
            background: linear-gradient(135deg, rgba(220, 220, 220, 0.65) 0%, rgba(210, 210, 210, 0.55) 100%);
            padding: 8px;
            border-radius: 100px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                inset 0 1px 1px rgba(255, 255, 255, 0.8),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .satellite-toggle {
            position: fixed;
            top: 45px;
            right: 20px;
            z-index: 1002;
            background: linear-gradient(135deg, rgba(220, 220, 220, 0.65) 0%, rgba(210, 210, 210, 0.55) 100%);
            padding: 10px 16px;
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                inset 0 1px 1px rgba(255, 255, 255, 0.8),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .satellite-toggle:hover {
            background: linear-gradient(135deg, rgba(230, 230, 230, 0.75) 0%, rgba(220, 220, 220, 0.65) 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 36px rgba(0, 0, 0, 0.15);
        }

        .satellite-toggle:active {
            transform: translateY(0);
        }

        .satellite-toggle-text {
            color: #1a1a1a;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .satellite-toggle-switch {
            width: 40px;
            height: 22px;
            background: rgba(100, 100, 100, 0.3);
            border-radius: 11px;
            position: relative;
            transition: background 0.3s ease;
        }

        .satellite-toggle-switch.active {
            background: #667eea;
        }

        .satellite-toggle-knob {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .satellite-toggle-switch.active .satellite-toggle-knob {
            transform: translateX(18px);
        }

        .satellite-bg {
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .satellite-bg.active {
            opacity: 1;
        }

        .utc-time {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 1002;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .control-btn {
            background: transparent;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 400;
            color: #1a1a1a;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.6);
            color: #000000;
            transform: scale(1.08);
        }

        .control-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.8);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #4a5568;
            text-align: center;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body {
                min-height: 100vh;
                min-height: 100dvh; /* Dynamic viewport height for mobile */
            }

            #map-container {
                margin: 0.5rem;
                flex: 1;
                min-height: 0; /* Allow flex shrinking */
            }

            header {
                padding: 1rem;
                flex-shrink: 0;
            }

            h1 {
                font-size: 1.5rem;
            }

            footer {
                padding: 0.5rem;
                font-size: 0.8rem;
                flex-shrink: 0;
            }

            .controls {
                top: 10px;
                right: 10px;
            }

            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }

            .country-info-card {
                min-width: 250px;
                max-width: 280px;
                padding: 1rem;
            }

            .country-name {
                font-size: 1.1rem;
            }
        }

        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow: hidden;
        }

        .splash-screen::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, #764ba2 0%, #667eea 50%, #764ba2 100%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: paintSplash 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            z-index: 1;
        }

        @keyframes paintSplash {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }
            60% {
                width: 300vmax;
                height: 300vmax;
                opacity: 1;
            }
            100% {
                width: 300vmax;
                height: 300vmax;
                opacity: 1;
            }
        }

        .splash-content {
            position: relative;
            z-index: 2;
            opacity: 0;
            animation: fadeInContent 0.6s ease-out 0.8s forwards;
        }

        @keyframes fadeInContent {
            to {
                opacity: 1;
            }
        }

        .splash-screen.fade-out {
            animation: fadeOutSplash 0.6s ease-in-out forwards;
        }

        @keyframes fadeOutSplash {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .splash-logo {
            font-size: 6rem;
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.3));
            animation: dropIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) 1s forwards;
            transform: translateY(-100px);
            opacity: 0;
        }

        @keyframes dropIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .splash-title {
            color: white;
            font-size: 6rem;
            font-weight: 700;
            margin-top: 1rem;
            letter-spacing: -0.02em;
            position: relative;
            font-family: 'Inter', sans-serif;
            text-shadow: 
                3px 3px 0px rgba(0, 0, 0, 0.3),
                5px 5px 10px rgba(0, 0, 0, 0.2),
                8px 8px 20px rgba(0, 0, 0, 0.15);
            animation: paintReveal 1.5s ease-out 1.2s forwards;
            background: linear-gradient(to right, 
                transparent 0%, 
                transparent 50%, 
                white 50%, 
                white 100%);
            background-size: 200% 100%;
            background-position: 0% 0%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.6));
            text-transform: capitalize;
        }

        @keyframes paintReveal {
            to {
                background-position: -100% 0%;
                -webkit-text-fill-color: white;
            }
        }

        .splash-title::before {
            content: 'Clickmap';
            position: absolute;
            top: 0;
            left: 0;
            color: rgba(255, 255, 255, 0.1);
            transform: translate(-3px, 3px);
            z-index: -1;
        }

        .splash-subtitle {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.3rem;
            margin-top: 1rem;
            font-weight: 400;
            letter-spacing: 0.05em;
            opacity: 0;
            animation: slideUp 0.6s ease-out 1.8s forwards;
            transform: translateY(20px);
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Paint drips */
        .paint-drip {
            position: absolute;
            width: 4px;
            background: rgba(255, 255, 255, 0.3);
            bottom: -100px;
            animation: drip 1.5s ease-in forwards;
            border-radius: 0 0 50% 50%;
            opacity: 0;
        }

        .paint-drip:nth-child(1) {
            left: 20%;
            height: 80px;
            animation-delay: 1.5s;
        }

        .paint-drip:nth-child(2) {
            left: 45%;
            height: 120px;
            animation-delay: 1.7s;
        }

        .paint-drip:nth-child(3) {
            left: 70%;
            height: 100px;
            animation-delay: 1.6s;
        }

        .paint-drip:nth-child(4) {
            left: 85%;
            height: 90px;
            animation-delay: 1.8s;
        }

        @keyframes drip {
            0% {
                top: 45%;
                opacity: 1;
            }
            100% {
                top: 100%;
                opacity: 0.5;
            }
        }

    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splash">
        <div class="splash-content">
            <div class="splash-logo">游깴</div>
            <h1 class="splash-title">Clickmap</h1>
            <p class="splash-subtitle">Explore the world in real-time</p>
        </div>
        <div class="paint-drip"></div>
        <div class="paint-drip"></div>
        <div class="paint-drip"></div>
        <div class="paint-drip"></div>
    </div>

    <div class="top-gradient"></div>
    <div class="logo">
        <h1>游깴 Clickmap</h1>
    </div>
    <div class="utc-time" id="utc-time"></div>

    <div style="display: flex; flex: 1; overflow: hidden;">
        <!-- Side Panel for Country Info -->
        <div class="info-panel" id="info-panel">
            <div class="panel-header">
                <div class="card-header">
                    <div class="flag-container">
                        <img id="country-flag" src="" alt="Flag">
                    </div>
                    <div class="country-name" id="country-name"></div>
                </div>
            </div>
            <div class="panel-content">
                <div id="country-details"></div>
                <a href="#" target="_blank" class="learn-more-btn" id="wiki-link">Learn More on Wikipedia</a>
            </div>
        </div>
        
        <div id="map-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading world map...</p>
            </div>
            
            <div class="controls">
                <button class="control-btn" id="zoom-in" title="Zoom In">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
                <button class="control-btn" id="zoom-out" title="Zoom Out">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
                <button class="control-btn" id="reset" title="Reset View">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                </button>
                <button class="control-btn" id="search-toggle" title="Search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </div>

            <!-- Satellite Mode Toggle -->
            <div class="satellite-toggle" id="satellite-toggle">
                <span class="satellite-toggle-text">Satellite</span>
                <div class="satellite-toggle-switch" id="satellite-switch">
                    <div class="satellite-toggle-knob"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="search-overlay" id="search-overlay"></div>
    
    <!-- Search Sidebar -->
    <div class="search-sidebar" id="search-sidebar">
        <div class="search-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="search-title">Search</div>
                <button id="search-close" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">칑</button>
            </div>
            <input type="text" class="search-input" id="search-input" placeholder="Search countries or cities...">
        </div>
        <div class="search-results" id="search-results">
            <div style="text-align: center; color: #718096; padding: 2rem;">Type to search...</div>
        </div>
    </div>

    <script>
        // Hide splash screen after animation completes
        setTimeout(() => {
            const splash = document.getElementById('splash');
            splash.classList.add('fade-out');
            setTimeout(() => {
                splash.style.display = 'none';
            }, 600);
        }, 2500);

        // Update UTC time
        function updateUTCTime() {
            const now = new Date();
            const utcTime = now.toUTCString().split(' ')[4];
            document.getElementById('utc-time').textContent = `UTC ${utcTime}`;
        }
        updateUTCTime();
        setInterval(updateUTCTime, 1000);

        // Realistic terrain colors matching satellite imagery
        const terrainColors = {
            // North African Sahara Desert (pale beige/tan from satellite)
            "Algeria": "#e8d5b7", "Libya": "#ead8ba", "Egypt": "#e5d3b5", "Saudi Arabia": "#e2d0b2",
            "Niger": "#d9c4a8", "Chad": "#dbc6aa", "Mali": "#dac5a9", "Mauritania": "#ddc8ab",
            "Sudan": "#d4bf9e", "Oman": "#d8c4a6", "Yemen": "#d5c1a3", "Jordan": "#dfc9ad",
            "United Arab Emirates": "#e0cbb0", "Kuwait": "#dec9ae", "Qatar": "#dfcaaf", 
            "Bahrain": "#dec9ae", "Iraq": "#cdb89a", "Syria": "#d2bd9f", "Namibia": "#d1b895",
            "Botswana": "#c5ac8a", "Mongolia": "#c8af8d", "Kazakhstan": "#c2a98b",
            
            // Tropical Rainforests (deep vibrant green from satellite)
            "Brazil": "#3d6e47", "Democratic Republic of the Congo": "#2a5c35", "Congo": "#326440",
            "Indonesia": "#376943", "Colombia": "#356741", "Peru": "#3e6f48", "Venezuela": "#376842",
            "Gabon": "#2f6139", "Cameroon": "#32633c", "Central African Republic": "#356743",
            "Ecuador": "#32633c", "Papua New Guinea": "#2e603a", "Malaysia": "#346640",
            "Myanmar": "#3a6b44", "Thailand": "#3b6c45", "Vietnam": "#386a43", "Laos": "#35673f",
            "Cambodia": "#3a6b44", "Philippines": "#376941", "Nigeria": "#346640",
            
            // North America/Asia Temperate (realistic forest green/brown mix)
            "United States": "#7a9765", "China": "#6e8b5f", "Russia": "#6d8a5e", "Canada": "#688858",
            "Australia": "#b8896a", "India": "#99a378", "Mexico": "#a89870", "Argentina": "#869a68",
            "France": "#8a9e6e", "Germany": "#839768", "Poland": "#809464", "Ukraine": "#84986a",
            "United Kingdom": "#7d9565", "Italy": "#8fa173", "Spain": "#96a577", "Turkey": "#929f72",
            "Japan": "#789363", "South Korea": "#7b9565", "North Korea": "#779261",
            
            // Arctic/Tundra (whites and light greys from ice)
            "Iceland": "#c5d1c8", "Norway": "#b5c2b9", "Sweden": "#b8c5bc", "Finland": "#b3c0b7",
            "Greenland": "#f2f6f8", "Alaska": "#bdcac1", "Antarctica": "#ffffff",
            
            // Mediterranean (golden browns and olive)
            "Greece": "#c5b593", "Tunisia": "#d1bb9a", "Morocco": "#cdb796", "Portugal": "#c0b38f",
            "Lebanon": "#cab691", "Palestine": "#ceb89a", "Cyprus": "#ccb798",
            
            // Mountain Ranges (grey-browns from elevation)
            "Afghanistan": "#b5a38f", "Pakistan": "#ab9985", "Nepal": "#a49281", "Bhutan": "#a79584",
            "Tajikistan": "#aa9787", "Kyrgyzstan": "#ad9a8a", "Switzerland": "#a2a695",
            "Austria": "#a6aa9f", "Chile": "#a89b8d", "Bolivia": "#b09f8c",
            
            // Agricultural Regions (bright fertile greens)
            "Bangladesh": "#9cb787", "Netherlands": "#96b489", "Belgium": "#98b68b", 
            "Denmark": "#9ab88d", "Ireland": "#91b083", "New Zealand": "#8fae81",
            
            // African Savanna/Mixed (browns and greens)
            "South Africa": "#a9ae8d", "Kenya": "#9dad86", "Tanzania": "#9aac84", 
            "Ethiopia": "#a4af90", "Somalia": "#cec2a2", "Uganda": "#94a981",
            "Zimbabwe": "#aab091", "Mozambique": "#9eac87", "Zambia": "#a0ad89",
            "Angola": "#97ab83", "Madagascar": "#93aa80", "Senegal": "#bcb18f",
            "Ghana": "#839a70", "Ivory Coast": "#859b72", "Burkina Faso": "#c9b898",
            "Benin": "#92a77e", "Togo": "#93a87f", "Guinea": "#869b71",
            "Sierra Leone": "#879e72", "Liberia": "#889f73", "Malawi": "#9aac84",
            "Rwanda": "#91a97f", "Burundi": "#92aa80", "Eritrea": "#cbbd9c",
            "Djibouti": "#ded3ad", "South Sudan": "#beb193"
        };

        // Default terrain color - natural mixed vegetation
        const defaultTerrainColor = "#97ab85";

        // Major cities database with coordinates
        const majorCities = {
            "United States": [
                {name: "Washington D.C.", lat: 38.9072, lon: -77.0369},
                {name: "New York", lat: 40.7128, lon: -74.0060},
                {name: "Los Angeles", lat: 34.0522, lon: -118.2437},
                {name: "Chicago", lat: 41.8781, lon: -87.6298},
                {name: "Houston", lat: 29.7604, lon: -95.3698}
            ],
            "China": [
                {name: "Beijing", lat: 39.9042, lon: 116.4074},
                {name: "Shanghai", lat: 31.2304, lon: 121.4737},
                {name: "Guangzhou", lat: 23.1291, lon: 113.2644},
                {name: "Shenzhen", lat: 22.5431, lon: 114.0579}
            ],
            "India": [
                {name: "New Delhi", lat: 28.6139, lon: 77.2090},
                {name: "Mumbai", lat: 19.0760, lon: 72.8777},
                {name: "Bangalore", lat: 12.9716, lon: 77.5946},
                {name: "Kolkata", lat: 22.5726, lon: 88.3639}
            ],
            "United Kingdom": [
                {name: "London", lat: 51.5074, lon: -0.1278},
                {name: "Manchester", lat: 53.4808, lon: -2.2426},
                {name: "Birmingham", lat: 52.4862, lon: -1.8904}
            ],
            "France": [
                {name: "Paris", lat: 48.8566, lon: 2.3522},
                {name: "Marseille", lat: 43.2965, lon: 5.3698},
                {name: "Lyon", lat: 45.7640, lon: 4.8357}
            ],
            "Germany": [
                {name: "Berlin", lat: 52.5200, lon: 13.4050},
                {name: "Munich", lat: 48.1351, lon: 11.5820},
                {name: "Hamburg", lat: 53.5511, lon: 9.9937}
            ],
            "Japan": [
                {name: "Tokyo", lat: 35.6762, lon: 139.6503},
                {name: "Osaka", lat: 34.6937, lon: 135.5023},
                {name: "Kyoto", lat: 35.0116, lon: 135.7681}
            ],
            "Brazil": [
                {name: "Bras칤lia", lat: -15.8267, lon: -47.9218},
                {name: "S칚o Paulo", lat: -23.5505, lon: -46.6333},
                {name: "Rio de Janeiro", lat: -22.9068, lon: -43.1729}
            ],
            "Australia": [
                {name: "Canberra", lat: -35.2809, lon: 149.1300},
                {name: "Sydney", lat: -33.8688, lon: 151.2093},
                {name: "Melbourne", lat: -37.8136, lon: 144.9631}
            ],
            "Canada": [
                {name: "Ottawa", lat: 45.4215, lon: -75.6972},
                {name: "Toronto", lat: 43.6532, lon: -79.3832},
                {name: "Vancouver", lat: 49.2827, lon: -123.1207}
            ],
            "Russia": [
                {name: "Moscow", lat: 55.7558, lon: 37.6173},
                {name: "Saint Petersburg", lat: 59.9343, lon: 30.3351},
                {name: "Novosibirsk", lat: 55.0084, lon: 82.9357}
            ],
            "Mexico": [
                {name: "Mexico City", lat: 19.4326, lon: -99.1332},
                {name: "Guadalajara", lat: 20.6597, lon: -103.3496},
                {name: "Monterrey", lat: 25.6866, lon: -100.3161}
            ],
            "Italy": [
                {name: "Rome", lat: 41.9028, lon: 12.4964},
                {name: "Milan", lat: 45.4642, lon: 9.1900},
                {name: "Naples", lat: 40.8518, lon: 14.2681}
            ],
            "Spain": [
                {name: "Madrid", lat: 40.4168, lon: -3.7038},
                {name: "Barcelona", lat: 41.3851, lon: 2.1734},
                {name: "Valencia", lat: 39.4699, lon: -0.3763}
            ],
            "South Korea": [
                {name: "Seoul", lat: 37.5665, lon: 126.9780},
                {name: "Busan", lat: 35.1796, lon: 129.0756},
                {name: "Incheon", lat: 37.4563, lon: 126.7052}
            ],
            "Turkey": [
                {name: "Ankara", lat: 39.9334, lon: 32.8597},
                {name: "Istanbul", lat: 41.0082, lon: 28.9784},
                {name: "Izmir", lat: 38.4237, lon: 27.1428}
            ],
            "Argentina": [
                {name: "Buenos Aires", lat: -34.6037, lon: -58.3816},
                {name: "C칩rdoba", lat: -31.4201, lon: -64.1888},
                {name: "Rosario", lat: -32.9442, lon: -60.6505}
            ],
            "South Africa": [
                {name: "Pretoria", lat: -25.7479, lon: 28.2293},
                {name: "Johannesburg", lat: -26.2041, lon: 28.0473},
                {name: "Cape Town", lat: -33.9249, lon: 18.4241}
            ],
            "Egypt": [
                {name: "Cairo", lat: 30.0444, lon: 31.2357},
                {name: "Alexandria", lat: 31.2001, lon: 29.9187},
                {name: "Giza", lat: 30.0131, lon: 31.2089}
            ],
            "Indonesia": [
                {name: "Jakarta", lat: -6.2088, lon: 106.8456},
                {name: "Surabaya", lat: -7.2575, lon: 112.7521},
                {name: "Bandung", lat: -6.9175, lon: 107.6191}
            ],
            "Saudi Arabia": [
                {name: "Riyadh", lat: 24.7136, lon: 46.6753},
                {name: "Jeddah", lat: 21.5433, lon: 39.1728},
                {name: "Mecca", lat: 21.3891, lon: 39.8579}
            ],
            "Nigeria": [
                {name: "Abuja", lat: 9.0765, lon: 7.3986},
                {name: "Lagos", lat: 6.5244, lon: 3.3792},
                {name: "Kano", lat: 12.0022, lon: 8.5920}
            ],
            "Poland": [
                {name: "Warsaw", lat: 52.2297, lon: 21.0122},
                {name: "Krak칩w", lat: 50.0647, lon: 19.9450},
                {name: "Wroc켹aw", lat: 51.1079, lon: 17.0385}
            ],
            "Netherlands": [
                {name: "Amsterdam", lat: 52.3676, lon: 4.9041},
                {name: "Rotterdam", lat: 51.9225, lon: 4.4792},
                {name: "The Hague", lat: 52.0705, lon: 4.3007}
            ],
            "Thailand": [
                {name: "Bangkok", lat: 13.7563, lon: 100.5018},
                {name: "Chiang Mai", lat: 18.7883, lon: 98.9853},
                {name: "Phuket", lat: 7.8804, lon: 98.3923}
            ],
            "Ukraine": [
                {name: "Kyiv", lat: 50.4501, lon: 30.5234},
                {name: "Kharkiv", lat: 49.9935, lon: 36.2304},
                {name: "Odesa", lat: 46.4825, lon: 30.7233}
            ],
            "Chile": [
                {name: "Santiago", lat: -33.4489, lon: -70.6693},
                {name: "Valpara칤so", lat: -33.0472, lon: -71.6127},
                {name: "Concepci칩n", lat: -36.8201, lon: -73.0444}
            ],
            "Colombia": [
                {name: "Bogot치", lat: 4.7110, lon: -74.0721},
                {name: "Medell칤n", lat: 6.2476, lon: -75.5658},
                {name: "Cali", lat: 3.4516, lon: -76.5320}
            ],
            "Peru": [
                {name: "Lima", lat: -12.0464, lon: -77.0428},
                {name: "Cusco", lat: -13.5319, lon: -71.9675},
                {name: "Arequipa", lat: -16.4090, lon: -71.5375}
            ],
            "Vietnam": [
                {name: "Hanoi", lat: 21.0285, lon: 105.8542},
                {name: "Ho Chi Minh City", lat: 10.8231, lon: 106.6297},
                {name: "Da Nang", lat: 16.0544, lon: 108.2022}
            ],
            "Philippines": [
                {name: "Manila", lat: 14.5995, lon: 120.9842},
                {name: "Cebu City", lat: 10.3157, lon: 123.8854},
                {name: "Davao City", lat: 7.1907, lon: 125.4553}
            ],
            "Pakistan": [
                {name: "Islamabad", lat: 33.6844, lon: 73.0479},
                {name: "Karachi", lat: 24.8607, lon: 67.0011},
                {name: "Lahore", lat: 31.5497, lon: 74.3436}
            ],
            "Bangladesh": [
                {name: "Dhaka", lat: 23.8103, lon: 90.4125},
                {name: "Chittagong", lat: 22.3569, lon: 91.7832},
                {name: "Khulna", lat: 22.8456, lon: 89.5403}
            ],
            "Malaysia": [
                {name: "Kuala Lumpur", lat: 3.1390, lon: 101.6869},
                {name: "George Town", lat: 5.4141, lon: 100.3288},
                {name: "Johor Bahru", lat: 1.4927, lon: 103.7414}
            ],
            "Morocco": [
                {name: "Rabat", lat: 34.0209, lon: -6.8416},
                {name: "Casablanca", lat: 33.5731, lon: -7.5898},
                {name: "Marrakesh", lat: 31.6295, lon: -7.9811}
            ],
            "Kenya": [
                {name: "Nairobi", lat: -1.2864, lon: 36.8172},
                {name: "Mombasa", lat: -4.0435, lon: 39.6682},
                {name: "Kisumu", lat: -0.0917, lon: 34.7680}
            ],
            "Greece": [
                {name: "Athens", lat: 37.9838, lon: 23.7275},
                {name: "Thessaloniki", lat: 40.6401, lon: 22.9444},
                {name: "Patras", lat: 38.2466, lon: 21.7346}
            ],
            "Portugal": [
                {name: "Lisbon", lat: 38.7223, lon: -9.1393},
                {name: "Porto", lat: 41.1579, lon: -8.6291},
                {name: "Faro", lat: 37.0194, lon: -7.9322}
            ],
            "New Zealand": [
                {name: "Wellington", lat: -41.2865, lon: 174.7762},
                {name: "Auckland", lat: -36.8485, lon: 174.7633},
                {name: "Christchurch", lat: -43.5321, lon: 172.6362}
            ],
            "Belgium": [
                {name: "Brussels", lat: 50.8503, lon: 4.3517},
                {name: "Antwerp", lat: 51.2194, lon: 4.4025},
                {name: "Ghent", lat: 51.0543, lon: 3.7174}
            ],
            "Sweden": [
                {name: "Stockholm", lat: 59.3293, lon: 18.0686},
                {name: "Gothenburg", lat: 57.7089, lon: 11.9746},
                {name: "Malm칬", lat: 55.6050, lon: 13.0038}
            ],
            "Norway": [
                {name: "Oslo", lat: 59.9139, lon: 10.7522},
                {name: "Bergen", lat: 60.3913, lon: 5.3221},
                {name: "Trondheim", lat: 63.4305, lon: 10.3951}
            ],
            "Denmark": [
                {name: "Copenhagen", lat: 55.6761, lon: 12.5683},
                {name: "Aarhus", lat: 56.1629, lon: 10.2039},
                {name: "Odense", lat: 55.4038, lon: 10.4024}
            ],
            "Finland": [
                {name: "Helsinki", lat: 60.1699, lon: 24.9384},
                {name: "Espoo", lat: 60.2055, lon: 24.6559},
                {name: "Tampere", lat: 61.4978, lon: 23.7610}
            ],
            "Austria": [
                {name: "Vienna", lat: 48.2082, lon: 16.3738},
                {name: "Graz", lat: 47.0707, lon: 15.4395},
                {name: "Salzburg", lat: 47.8095, lon: 13.0550}
            ],
            "Switzerland": [
                {name: "Bern", lat: 46.9480, lon: 7.4474},
                {name: "Zurich", lat: 47.3769, lon: 8.5417},
                {name: "Geneva", lat: 46.2044, lon: 6.1432}
            ],
            "Czech Republic": [
                {name: "Prague", lat: 50.0755, lon: 14.4378},
                {name: "Brno", lat: 49.1951, lon: 16.6068},
                {name: "Ostrava", lat: 49.8209, lon: 18.2625}
            ],
            "Romania": [
                {name: "Bucharest", lat: 44.4268, lon: 26.1025},
                {name: "Cluj-Napoca", lat: 46.7712, lon: 23.6236},
                {name: "Timi탳oara", lat: 45.7489, lon: 21.2087}
            ],
            "Hungary": [
                {name: "Budapest", lat: 47.4979, lon: 19.0402},
                {name: "Debrecen", lat: 47.5316, lon: 21.6273},
                {name: "Szeged", lat: 46.2530, lon: 20.1414}
            ],
            "Ireland": [
                {name: "Dublin", lat: 53.3498, lon: -6.2603},
                {name: "Cork", lat: 51.8985, lon: -8.4756},
                {name: "Galway", lat: 53.2707, lon: -9.0568}
            ],
            "Singapore": [
                {name: "Singapore", lat: 1.3521, lon: 103.8198}
            ],
            "Hong Kong": [
                {name: "Hong Kong", lat: 22.3193, lon: 114.1694}
            ],
            "Taiwan": [
                {name: "Taipei", lat: 25.0330, lon: 121.5654},
                {name: "Kaohsiung", lat: 22.6273, lon: 120.3014},
                {name: "Taichung", lat: 24.1477, lon: 120.6736}
            ],
            "Israel": [
                {name: "Jerusalem", lat: 31.7683, lon: 35.2137},
                {name: "Tel Aviv", lat: 32.0853, lon: 34.7818},
                {name: "Haifa", lat: 32.7940, lon: 34.9896}
            ],
            "Venezuela": [
                {name: "Caracas", lat: 10.4806, lon: -66.9036},
                {name: "Maracaibo", lat: 10.6666, lon: -71.6124},
                {name: "Valencia", lat: 10.1621, lon: -68.0077}
            ],
            "Ecuador": [
                {name: "Quito", lat: -0.1807, lon: -78.4678},
                {name: "Guayaquil", lat: -2.1709, lon: -79.9224},
                {name: "Cuenca", lat: -2.9001, lon: -79.0059}
            ]
        };

        // Configuration
        const width = 465.6;
        const height = 612;
        let currentZoom = 1;
        let activeCountry = null;
        const countryDataCache = {};
        let isMobile = window.matchMedia("(max-width: 768px)").matches;
        let allCountriesData = [];
        let currentSelectedCity = null;

        // Create SVG
        const svg = d3.select("#map-container")
            .append("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet");

        // Blue ocean background - extended for wrapping
        const oceanRect = svg.append("rect")
            .attr("class", "ocean")
            .attr("x", -width * 2)
            .attr("y", 0)
            .attr("width", width * 5)
            .attr("height", height);

        const g = svg.append("g");

        // Projection - using a wrapping projection for infinite scroll
        // Scale reduced significantly to fit everything in viewport
        const projection = d3.geoMercator()
            .scale(100)
            .translate([width / 2, height / 2.05])
            .center([0, 0]);

        const path = d3.geoPath().projection(projection);

        // Calculate proper bounds for satellite image using projection
        const topLeft = projection([-180, 85]);
        const bottomRight = projection([180, -85]);
        const imageWidth = bottomRight[0] - topLeft[0];
        const imageHeight = height * 1.35; // Stretch vertically to cover map area

        // Enable infinite horizontal wrapping
        let currentTransform = d3.zoomIdentity;

        // Store map width for wrapping calculations
        let actualMapWidth = 0;

        // Zoom behavior with seamless wrapping
        const zoom = d3.zoom()
            .scaleExtent([1, 20])
            .filter(function(event) {
                // Allow all interactions
                return !event.button && event.type !== 'dblclick';
            })
            .on("zoom", (event) => {
                currentTransform = event.transform;
                currentZoom = event.transform.k;
                
                // Allow vertical panning when zoomed in, constrain to map bounds
                let finalY = event.transform.y;
                
                // When zoomed in, allow vertical movement but constrain
                if (currentZoom > 1) {
                    // Calculate the visible height and scaled map height
                    const scaledHeight = height * currentZoom;
                    const visibleHeight = height;
                    
                    // Maximum Y offset (can't pan above the top)
                    const maxY = 0;
                    // Minimum Y offset (can't pan below Antarctica)
                    const minY = -(scaledHeight - visibleHeight);
                    
                    // Constrain Y within bounds
                    finalY = Math.max(minY, Math.min(maxY, finalY));
                } else {
                    // At zoom level 1, lock Y to 0
                    finalY = 0;
                }
                
                // Apply constrained transform
                const constrainedTransform = d3.zoomIdentity
                    .translate(event.transform.x, finalY)
                    .scale(currentZoom);
                
                g.attr("transform", constrainedTransform);
                
                // Check if we've scrolled too far horizontally and need to wrap
                if (actualMapWidth > 0) {
                    const scaledMapWidth = actualMapWidth * currentZoom;
                    const threshold = scaledMapWidth * 0.8; // Wrap before fully off-screen
                    
                    // If scrolled too far right, teleport back
                    if (event.transform.x < -threshold) {
                        const newX = event.transform.x + scaledMapWidth;
                        const newTransform = d3.zoomIdentity
                            .translate(newX, finalY)
                            .scale(currentZoom);
                        svg.call(zoom.transform, newTransform);
                        return;
                    }
                    
                    // If scrolled too far left, teleport back
                    if (event.transform.x > threshold) {
                        const newX = event.transform.x - scaledMapWidth;
                        const newTransform = d3.zoomIdentity
                            .translate(newX, finalY)
                            .scale(currentZoom);
                        svg.call(zoom.transform, newTransform);
                        return;
                    }
                }
                
                // Adjust stroke width and label size based on zoom
                g.selectAll(".country")
                    .style("stroke-width", Math.max(0.1, 0.5 / currentZoom));
                
                // Scale down country labels when zooming in
                g.selectAll(".country-label")
                    .style("font-size", function() {
                        const baseSize = d3.select(this).classed("country-label-small") ? 5 : 7;
                        return `${baseSize / currentZoom}px`;
                    });
            });

        svg.call(zoom);

        // Control buttons
        d3.select("#zoom-in").on("click", () => {
            svg.transition().duration(300).call(zoom.scaleBy, 1.5);
        });

        d3.select("#zoom-out").on("click", () => {
            svg.transition().duration(300).call(zoom.scaleBy, 0.67);
        });

        d3.select("#reset").on("click", () => {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
            hideInfoCard();
        });

        // Country name mapping for special cases
        const countryNameMapping = {
            "Israel": "Palestine",
            "United States of America": "United States",
            "Dem. Rep. Korea": "North Korea",
            "Korea": "South Korea",
            "Lao PDR": "Laos",
            "Bosnia and Herz.": "Bosnia and Herzegovina",
            "Dominican Rep.": "Dominican Republic",
            "Central African Rep.": "Central African Republic",
            "Eq. Guinea": "Equatorial Guinea",
            "Czechia": "Czech Republic",
            "Macedonia": "North Macedonia",
            "C칪te d'Ivoire": "Ivory Coast",
            "Dem. Rep. Congo": "Democratic Republic of the Congo",
            "Congo": "Republic of the Congo",
            "S. Sudan": "South Sudan",
            "Timor-Leste": "East Timor"
        };

        

        // Fetch country data from REST Countries API
        async function fetchCountryData(countryName) {
            // Check cache first
            if (countryDataCache[countryName]) {
                return countryDataCache[countryName];
            }

            try {
                const mappedName = countryNameMapping[countryName] || countryName;
                const response = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(mappedName)}?fullText=true`);
                
                if (!response.ok) {
                    throw new Error('Country not found');
                }

                const data = await response.json();
                const country = data[0];

                // Get timezone and calculate local time
                let localTime = "N/A";
                
                // Try to get a valid IANA timezone from the country's timezone list
                if (country.timezones && country.timezones.length > 0) {
                    // Filter out UTC offsets and look for IANA timezone identifiers
                    const validTimezones = country.timezones.filter(tz => 
                        !tz.startsWith('UTC') && tz.includes('/')
                    );
                    
                    const timezone = validTimezones.length > 0 ? validTimezones[0] : country.timezones[0];
                    
                    try {
                        const now = new Date();
                        localTime = now.toLocaleTimeString('en-US', {
                            timeZone: timezone,
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                    } catch (e) {
                        // If timezone doesn't work, try calculating from UTC offset
                        const utcOffset = country.timezones[0];
                        if (utcOffset && utcOffset.startsWith('UTC')) {
                            try {
                                const offsetMatch = utcOffset.match(/UTC([+-]\d+(?::\d+)?)?/);
                                if (offsetMatch && offsetMatch[1]) {
                                    const [hours, minutes = 0] = offsetMatch[1].split(':').map(n => parseInt(n));
                                    const now = new Date();
                                    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                                    const localDate = new Date(utc + (3600000 * hours) + (60000 * minutes));
                                    localTime = localDate.toLocaleTimeString('en-US', {
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        hour12: true
                                    });
                                }
                            } catch (err) {
                                console.warn(`Could not calculate time for ${countryName}:`, err);
                            }
                        }
                    }
                }

                // Fetch weather data for capital city
                let weather = null;
                if (country.capitalInfo && country.capitalInfo.latlng) {
                    try {
                        const [lat, lon] = country.capitalInfo.latlng;
                        const weatherResponse = await fetch(
                            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&temperature_unit=celsius`
                        );
                        
                        if (weatherResponse.ok) {
                            const weatherData = await weatherResponse.json();
                            const current = weatherData.current;
                            
                            // Map weather codes to descriptions
                            const weatherCodeMap = {
                                0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
                                45: "Foggy", 48: "Foggy", 51: "Light drizzle", 53: "Drizzle", 55: "Heavy drizzle",
                                61: "Light rain", 63: "Rain", 65: "Heavy rain", 71: "Light snow", 73: "Snow", 
                                75: "Heavy snow", 77: "Snow grains", 80: "Light showers", 81: "Showers", 
                                82: "Heavy showers", 85: "Light snow showers", 86: "Snow showers", 
                                95: "Thunderstorm", 96: "Thunderstorm with hail", 99: "Thunderstorm with hail"
                            };
                            
                            weather = {
                                temp: `${Math.round(current.temperature_2m)}춿C`,
                                humidity: `${current.relative_humidity_2m}%`,
                                windSpeed: `${Math.round(current.wind_speed_10m)} km/h`,
                                condition: weatherCodeMap[current.weather_code] || "Unknown"
                            };
                        }
                    } catch (err) {
                        console.warn(`Could not fetch weather for ${countryName}:`, err);
                    }
                }

                const countryInfo = {
                    name: country.name.common,
                    flag: country.flags.svg || country.flags.png,
                    population: country.population.toLocaleString(),
                    capital: country.capital ? country.capital[0] : "N/A",
                    localTime: localTime,
                    weather: weather,
                    wikiLink: `https://en.wikipedia.org/wiki/${encodeURIComponent(country.name.common)}`
                };

                countryDataCache[countryName] = countryInfo;
                return countryInfo;
            } catch (error) {
                console.error(`Error fetching data for ${countryName}:`, error);
                return {
                    name: countryName,
                    flag: '',
                    population: "Data unavailable",
                    capital: "Data unavailable",
                    localTime: "Data unavailable",
                    weather: null,
                    wikiLink: `https://en.wikipedia.org/wiki/${encodeURIComponent(countryName)}`
                };
            }
        }

        // Fetch weather and time for a specific city
        async function fetchCityData(cityName, lat, lon) {
            let weather = null;
            let localTime = "N/A";
            
            try {
                // Fetch weather
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&temperature_unit=celsius&timezone=auto`
                );
                
                if (weatherResponse.ok) {
                    const weatherData = await weatherResponse.json();
                    const current = weatherData.current;
                    
                    const weatherCodeMap = {
                        0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
                        45: "Foggy", 48: "Foggy", 51: "Light drizzle", 53: "Drizzle", 55: "Heavy drizzle",
                        61: "Light rain", 63: "Rain", 65: "Heavy rain", 71: "Light snow", 73: "Snow", 
                        75: "Heavy snow", 77: "Snow grains", 80: "Light showers", 81: "Showers", 
                        82: "Heavy showers", 85: "Light snow showers", 86: "Snow showers", 
                        95: "Thunderstorm", 96: "Thunderstorm with hail", 99: "Thunderstorm with hail"
                    };
                    
                    weather = {
                        temp: `${Math.round(current.temperature_2m)}춿C`,
                        humidity: `${current.relative_humidity_2m}%`,
                        windSpeed: `${Math.round(current.wind_speed_10m)} km/h`,
                        condition: weatherCodeMap[current.weather_code] || "Unknown"
                    };
                    
                    // Get local time from timezone
                    if (weatherData.timezone) {
                        const cityDate = new Date(current.time);
                        localTime = cityDate.toLocaleTimeString('en-US', {
                            timeZone: weatherData.timezone,
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                    }
                }
            } catch (err) {
                console.warn(`Could not fetch data for ${cityName}:`, err);
            }
            
            return { weather, localTime, cityName };
        }

        // Show info panel
        async function showInfoCard(countryData, event, selectedCity = null) {
            const panel = document.getElementById('info-panel');
            
            // Update panel content
            document.getElementById('country-flag').src = countryData.flag;
            document.getElementById('country-flag').alt = `${countryData.name} flag`;
            document.getElementById('country-name').textContent = countryData.name;
            
            // Get cities for this country
            const cities = majorCities[countryData.name] || [];
            let cityDropdownHTML = '';
            
            if (cities.length > 0) {
                cityDropdownHTML = `
                    <div class="city-selector">
                        <label for="city-dropdown">Select City:</label>
                        <select class="city-dropdown" id="city-dropdown">
                            ${cities.map((city, idx) => 
                                `<option value="${idx}" ${(!selectedCity && idx === 0) || (selectedCity && city.name === selectedCity.name) ? 'selected' : ''}>${city.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            }
            
            // If a city is selected, fetch its data, otherwise use capital data
            let displayData = countryData;
            if (selectedCity) {
                const cityData = await fetchCityData(selectedCity.name, selectedCity.lat, selectedCity.lon);
                displayData = {
                    ...countryData,
                    weather: cityData.weather,
                    localTime: cityData.localTime,
                    capital: selectedCity.name
                };
                currentSelectedCity = selectedCity;
            } else if (cities.length > 0) {
                // Default to first city (capital)
                const firstCity = cities[0];
                const cityData = await fetchCityData(firstCity.name, firstCity.lat, firstCity.lon);
                displayData = {
                    ...countryData,
                    weather: cityData.weather,
                    localTime: cityData.localTime,
                    capital: firstCity.name
                };
                currentSelectedCity = firstCity;
            } else {
                currentSelectedCity = null;
            }
            
            let weatherHTML = '';
            if (displayData.weather) {
                // Determine weather icon based on condition
                // Determine if it's night time based on local time
                const timeStr = displayData.localTime;
                const hour = timeStr ? parseInt(timeStr.split(':')[0]) : 12;
                const isNight = hour < 6 || hour >= 20;
                
                let weatherIcon = isNight ? '游깿' : '驕勇'; // Default based on time
                const condition = displayData.weather.condition.toLowerCase();
                
                if (condition.includes('clear')) {
                    weatherIcon = isNight ? '游깿' : '驕勇';
                } else if (condition.includes('partly') || condition.includes('mainly')) {
                    weatherIcon = isNight ? '驕勇' : '久';
                } else if (condition.includes('overcast') || condition.includes('cloud')) {
                    weatherIcon = '驕勇';
                } else if (condition.includes('rain') || condition.includes('shower')) {
                    weatherIcon = '游꺊勇';
                } else if (condition.includes('drizzle')) {
                    weatherIcon = '游꺉勇';
                } else if (condition.includes('snow')) {
                    weatherIcon = '仇勇';
                } else if (condition.includes('thunder') || condition.includes('storm')) {
                    weatherIcon = '久걾잺';
                } else if (condition.includes('fog') || condition.includes('mist')) {
                    weatherIcon = '游꺎勇';
                }
                
                weatherHTML = `
                    <div class="weather-widget">
                        <div class="weather-icon">${weatherIcon}</div>
                        <div class="weather-main">
                            <div class="weather-condition">${displayData.weather.condition}</div>
                            <div class="weather-temp">${displayData.weather.temp.replace('춿C', '춿')}</div>
                        </div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <span class="weather-detail-label">Humidity</span>
                                <span class="weather-detail-value">${displayData.weather.humidity}</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-detail-label">Wind</span>
                                <span class="weather-detail-value">${displayData.weather.windSpeed}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const detailsHTML = `
                ${cityDropdownHTML}
                ${weatherHTML}
                <div class="info-row">
                    <span class="info-label">City</span>
                    <span class="info-value">${displayData.capital}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Local Time</span>
                    <span class="info-value">${displayData.localTime}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Population</span>
                    <span class="info-value">${countryData.population}</span>
                </div>
            `;
            document.getElementById('country-details').innerHTML = detailsHTML;
            document.getElementById('wiki-link').href = countryData.wikiLink;
            
            // Add event listener to city dropdown
            const cityDropdown = document.getElementById('city-dropdown');
            if (cityDropdown) {
                cityDropdown.addEventListener('change', async function() {
                    const selectedIndex = parseInt(this.value);
                    const selectedCity = cities[selectedIndex];
                    await showInfoCard(countryData, event, selectedCity);
                });
            }
        }

        // Hide info card (deselect country)
        function hideInfoCard() {
            if (activeCountry) {
                d3.select(activeCountry).classed('active', false);
                activeCountry = null;
            }
        }

        // Handle country interaction
        async function handleCountryInteraction(event, d) {
            const countryName = d.properties.name;
            const countryElement = event.currentTarget;

            // If clicking the same country, hide it
            if (activeCountry === countryElement) {
                hideInfoCard();
                return;
            }

            // Remove active class from previous country
            if (activeCountry && activeCountry !== countryElement) {
                d3.select(activeCountry).classed('active', false);
            }

            // Set new active country
            activeCountry = countryElement;
            d3.select(countryElement).classed('active', true);

            // Fetch and show country data
            const countryData = await fetchCountryData(countryName);
            showInfoCard(countryData, event);
        }

        // Load and render the map
        async function loadMap() {
            try {
                // Load world map data from topojson - using 50m for higher detail
                const world = await d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json");
                const countries = topojson.feature(world, world.objects.countries);

                // Remove loading indicator
                d3.select(".loading").remove();

                // Draw timezone boundaries using real-world timezone data
                async function drawTimezoneLines(parentGroup, xOffset = 0) {
                    const timezoneGroup = parentGroup.append("g")
                        .attr("class", "timezone-boundaries")
                        .attr("transform", `translate(${xOffset}, 0)`);

                    try {
                        // Try multiple timezone data sources
                        let timezoneData = null;
                        
                        try {
                            // Try primary source
                            timezoneData = await d3.json("https://raw.githubusercontent.com/evansiroky/timezone-boundary-builder/master/dist/combined.json");
                        } catch (e) {
                            // Fallback source
                            timezoneData = await d3.json("https://cdn.jsdelivr.net/npm/@datahub/core@0.8.8/data/world-timezones.json");
                        }

                        if (timezoneData && timezoneData.features) {
                            // Draw each timezone boundary
                            timezoneData.features.forEach(feature => {
                                timezoneGroup.append("path")
                                    .datum(feature)
                                    .attr("class", "timezone-boundary")
                                    .attr("d", path);
                            });
                        } else {
                            throw new Error("No timezone data");
                        }
                    } catch (error) {
                        console.warn("Using simplified timezone lines:", error);
                        // Fallback to simplified meridian-based lines
                        for (let lon = -180; lon <= 165; lon += 15) {
                            const points = [];
                            for (let lat = -85; lat <= 85; lat += 1) {
                                const projected = projection([lon, lat]);
                                if (projected) points.push(projected);
                            }

                            if (points.length > 0) {
                                const lineGenerator = d3.line()
                                    .x(d => d[0])
                                    .y(d => d[1]);

                                timezoneGroup.append("path")
                                    .attr("d", lineGenerator(points))
                                    .attr("class", "timezone-boundary");

                                // Add label at top
                                const hourOffset = lon / 15;
                                const label = hourOffset === 0 ? 'UTC' : 
                                            hourOffset > 0 ? `UTC+${hourOffset}` : 
                                            `UTC${hourOffset}`;
                                
                                timezoneGroup.append("text")
                                    .attr("class", "timezone-label")
                                    .attr("x", points[0][0])
                                    .attr("y", points[0][1] - 10)
                                    .text(label);
                            }
                        }
                    }
                }

                // Draw latitude lines first (behind countries)
                function drawLatitudeLines(parentGroup, xOffset = 0) {
                    const latitudeGroup = parentGroup.append("g")
                        .attr("class", "latitude-lines")
                        .attr("transform", `translate(${xOffset}, 0)`);

                    const latitudes = [
                        { lat: 0, label: "Equator", class: "equator" },
                        { lat: 23.43656, label: "Tropic of Cancer", class: "" },
                        { lat: -23.43656, label: "Tropic of Capricorn", class: "" },
                        { lat: 66.563, label: "Arctic Circle", class: "" },
                        { lat: -66.563, label: "Antarctic Circle", class: "" }
                    ];

                    latitudes.forEach(item => {
                        const points = [];
                        for (let lon = -180; lon <= 180; lon += 2) {
                            const projected = projection([lon, item.lat]);
                            if (projected) {
                                points.push(projected);
                            }
                        }

                        if (points.length > 0) {
                            const lineGenerator = d3.line()
                                .x(d => d[0])
                                .y(d => d[1]);

                            latitudeGroup.append("path")
                                .attr("d", lineGenerator(points))
                                .attr("class", `latitude-line ${item.class}`);

                            const labelX = points[Math.floor(points.length * 0.85)][0];
                            const labelY = points[Math.floor(points.length * 0.85)][1];
                            
                            latitudeGroup.append("text")
                                .attr("class", "latitude-label")
                                .attr("x", labelX)
                                .attr("y", labelY - 5)
                                .text(item.label);
                        }
                    });
                }

                // Calculate the actual width needed for proper wrapping
                // The map spans from -180 to 180 longitude
                const leftBound = projection([-180, 0])[0];
                const rightBound = projection([180, 0])[0];
                const mapWidth = rightBound - leftBound;
                actualMapWidth = mapWidth; // Store for zoom handler

                // Add satellite images first (so they appear behind countries)
                const satelliteOffsets = [-mapWidth * 2, -mapWidth, 0, mapWidth, mapWidth * 2];
                satelliteOffsets.forEach(offset => {
                    g.append("image")
                        .attr("class", "satellite-bg")
                        .attr("href", "https://eoimages.gsfc.nasa.gov/images/imagerecords/73000/73909/world.topo.bathy.200412.3x5400x2700.jpg")
                        .attr("x", topLeft[0] + offset)
                        .attr("y", -height * 0.18)
                        .attr("width", imageWidth)
                        .attr("height", imageHeight)
                        .style("opacity", 0)
                        .lower(); // Ensure satellite images are behind everything
                });

                // Function to render countries at a given x offset for wrapping
                function renderCountries(xOffset = 0) {
                    const group = g.append("g").attr("transform", `translate(${xOffset}, 0)`);
                    
                    group.selectAll(".country")
                        .data(countries.features)
                        .enter()
                        .append("path")
                        .attr("class", "country")
                        .attr("d", path)
                        .style("fill", function(d) {
                            // Get country name
                            const id = d.id;
                            let countryName = world.objects.countries.geometries
                                .find(g => g.id === id)?.properties?.name || "Unknown";
                            
                            // Replace Israel with Palestine
                            if (countryName === "Israel") {
                                countryName = "Palestine";
                            }
                            
                            // Return terrain color or default
                            return terrainColors[countryName] || defaultTerrainColor;
                        })
                        .each(function(d) {
                            // Add country name to properties
                            const id = d.id;
                            let countryName = world.objects.countries.geometries
                                .find(g => g.id === id)?.properties?.name || "Unknown";
                            
                            // Replace Israel with Palestine
                            if (countryName === "Israel") {
                                countryName = "Palestine";
                            }
                            
                            d.properties.name = countryName;
                        })
                        .on("click", function(event, d) {
                            event.stopPropagation();
                            handleCountryInteraction(event, d);
                        });
                    
                    // Add country name labels
                    group.selectAll(".country-label")
                        .data(countries.features)
                        .enter()
                        .append("text")
                        .attr("class", function(d) {
                            const bounds = path.bounds(d);
                            const area = (bounds[1][0] - bounds[0][0]) * (bounds[1][1] - bounds[0][1]);
                            return area < 100 ? "country-label country-label-small" : "country-label";
                        })
                        .attr("transform", function(d) {
                            const centroid = path.centroid(d);
                            return `translate(${centroid[0]}, ${centroid[1]})`;
                        })
                        .attr("text-anchor", "middle")
                        .attr("dy", ".35em")
                        .text(function(d) {
                            let name = d.properties.name;
                            // Replace Israel with Palestine
                            if (name === "Israel") {
                                name = "Palestine";
                            }
                            
                            // Abbreviate long names for small countries
                            const bounds = path.bounds(d);
                            const width = bounds[1][0] - bounds[0][0];
                            const area = width * (bounds[1][1] - bounds[0][1]);
                            
                            if (area < 200 && name.length > 15) {
                                // Use abbreviations for small countries
                                const abbr = {
                                    "Bosnia and Herzegovina": "Bosnia",
                                    "Central African Republic": "CAR",
                                    "Dominican Republic": "Dom. Rep.",
                                    "Equatorial Guinea": "Eq. Guinea",
                                    "United Arab Emirates": "UAE",
                                    "Democratic Republic of the Congo": "DR Congo",
                                    "Republic of the Congo": "Congo"
                                };
                                return abbr[name] || name;
                            }
                            
                            return name;
                        })
                        .style("pointer-events", "none");
                }

                // Render 5 copies for better coverage: far left, left, center, right, far right
                renderCountries(-mapWidth * 2);
                renderCountries(-mapWidth);
                renderCountries(0);
                renderCountries(mapWidth);
                renderCountries(mapWidth * 2);

                // Draw time zone lines AFTER countries (so they appear on top) - for all 5 copies
                await drawTimezoneLines(g, -mapWidth * 2);
                await drawTimezoneLines(g, -mapWidth);
                await drawTimezoneLines(g, 0);
                await drawTimezoneLines(g, mapWidth);
                await drawTimezoneLines(g, mapWidth * 2);

                // Draw latitude lines AFTER countries (so they appear on top) - for all 5 copies
                drawLatitudeLines(g, -mapWidth * 2);
                drawLatitudeLines(g, -mapWidth);
                drawLatitudeLines(g, 0);
                drawLatitudeLines(g, mapWidth);
                drawLatitudeLines(g, mapWidth * 2);

                // Click outside to deselect
                svg.on("click", () => {
                    hideInfoCard();
                });

                // Detect and show user's country
                const userCountry = await detectUserCountry();
                if (userCountry) {
                    // Find the country in the map and simulate click
                    const countryPath = d3.selectAll('.country')
                        .filter(function(d) { return d.properties.name === userCountry; })
                        .node();
                    
                    if (countryPath) {
                        const countryData = d3.select(countryPath).datum();
                        
                        // Calculate country centroid for zooming
                        const bounds = path.bounds(countryData);
                        const dx = bounds[1][0] - bounds[0][0];
                        const dy = bounds[1][1] - bounds[0][1];
                        const x = (bounds[0][0] + bounds[1][0]) / 2;
                        const y = (bounds[0][1] + bounds[1][1]) / 2;
                        const scale = Math.max(1, Math.min(6, 0.9 / Math.max(dx / width, dy / height)));
                        const translate = [width / 2 - scale * x, height / 2 - scale * y];
                        
                        // Zoom to country
                        svg.transition()
                            .duration(1500)
                            .call(
                                zoom.transform,
                                d3.zoomIdentity
                                    .translate(translate[0], translate[1])
                                    .scale(scale)
                            );
                        
                        // Show country info after zoom
                        setTimeout(async () => {
                            const event = { currentTarget: countryPath };
                            await handleCountryInteraction(event, countryData);
                        }, 1500);
                    }
                }

            } catch (error) {
                console.error("Error loading map:", error);
                d3.select(".loading p").text("Error loading map. Please refresh the page.");
            }
        }

        // Detect user's country and show it on load
        async function detectUserCountry() {
            try {
                // Use ipapi.co for geolocation
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return data.country_name;
            } catch (error) {
                console.error('Error detecting user location:', error);
                return null;
            }
        }

        // Build search index of all countries and cities
        function buildSearchIndex() {
            const searchIndex = [];
            
            // Add all countries
            for (const countryName in terrainColors) {
                searchIndex.push({
                    type: 'country',
                    name: countryName,
                    searchText: countryName.toLowerCase()
                });
            }
            
            // Add all major cities
            for (const countryName in majorCities) {
                const cities = majorCities[countryName];
                cities.forEach(city => {
                    searchIndex.push({
                        type: 'city',
                        name: city.name,
                        country: countryName,
                        lat: city.lat,
                        lon: city.lon,
                        searchText: `${city.name} ${countryName}`.toLowerCase()
                    });
                });
            }
            
            return searchIndex;
        }

        // Handle search input
        function handleSearch(query) {
            const searchResults = document.getElementById('search-results');
            
            if (!query || query.length < 2) {
                searchResults.innerHTML = '<div style="text-align: center; color: #718096; padding: 2rem;">Type to search...</div>';
                return;
            }
            
            const searchIndex = buildSearchIndex();
            const results = searchIndex.filter(item => 
                item.searchText.includes(query.toLowerCase())
            ).slice(0, 20); // Limit to 20 results
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div style="text-align: center; color: #718096; padding: 2rem;">No results found</div>';
                return;
            }
            
            searchResults.innerHTML = results.map(result => `
                <div class="search-result-item" data-type="${result.type}" data-name="${result.name}" data-country="${result.country || result.name}" data-lat="${result.lat || ''}" data-lon="${result.lon || ''}">
                    <div class="result-name">${result.name}</div>
                    <div class="result-type">${result.type === 'country' ? 'Country' : `City in ${result.country}`}</div>
                </div>
            `).join('');
            
            // Add click handlers to results
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', async function() {
                    const type = this.dataset.type;
                    const name = this.dataset.name;
                    const country = this.dataset.country;
                    
                    if (type === 'country') {
                        // Find and click the country on the map
                        const countryPath = d3.selectAll('.country')
                            .filter(function(d) { return d.properties.name === country; })
                            .node();
                        
                        if (countryPath) {
                            const countryData = d3.select(countryPath).datum();
                            const event = { currentTarget: countryPath };
                            await handleCountryInteraction(event, countryData);
                        }
                    } else {
                        // City selected - load country data then select city
                        const countryPath = d3.selectAll('.country')
                            .filter(function(d) { return d.properties.name === country; })
                            .node();
                        
                        if (countryPath) {
                            const countryData = d3.select(countryPath).datum();
                            const countryName = countryData.properties.name;
                            
                            // Get full country data
                            const fullCountryData = await getCountryData(countryName);
                            
                            // Find the selected city
                            const cities = majorCities[country] || [];
                            const selectedCity = cities.find(c => c.name === name);
                            
                            if (selectedCity) {
                                await showInfoCard(fullCountryData, { currentTarget: countryPath }, selectedCity);
                                
                                // Highlight country on map
                                if (activeCountry && activeCountry !== countryPath) {
                                    d3.select(activeCountry).classed('active', false);
                                }
                                d3.select(countryPath).classed('active', true);
                                activeCountry = countryPath;
                                
                                // Close search sidebar
                                closeSearch();
                            }
                        }
                    }
                });
            });
        }

        // Initialize - delay until splash finishes
        setTimeout(() => {
            loadMap();
        }, 3100); // Splash takes 2500ms + 600ms fade

        // Handle window resize
        window.addEventListener('resize', () => {
            isMobile = window.matchMedia("(max-width: 768px)").matches;
        });

        // Search toggle functionality
        const searchSidebar = document.getElementById('search-sidebar');
        const searchOverlay = document.getElementById('search-overlay');
        const searchToggle = document.getElementById('search-toggle');

        function openSearch() {
            searchSidebar.classList.add('visible');
            searchOverlay.classList.add('visible');
            document.getElementById('search-input').focus();
        }

        function closeSearch() {
            searchSidebar.classList.remove('visible');
            searchOverlay.classList.remove('visible');
        }

        searchToggle.addEventListener('click', () => {
            if (searchSidebar.classList.contains('visible')) {
                closeSearch();
            } else {
                openSearch();
            }
        });

        searchOverlay.addEventListener('click', closeSearch);
        document.getElementById('search-close').addEventListener('click', closeSearch);

        // Search input handler
        const searchInput = document.getElementById('search-input');
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                handleSearch(this.value);
            }, 300); // Debounce search by 300ms
        });

        // Satellite mode toggle functionality
        let satelliteModeActive = false;
        const satelliteToggle = document.getElementById('satellite-toggle');
        const satelliteSwitch = document.getElementById('satellite-switch');

        satelliteToggle.addEventListener('click', () => {
            satelliteModeActive = !satelliteModeActive;
            satelliteSwitch.classList.toggle('active');
            
            if (satelliteModeActive) {
                // Show all satellite imagery
                d3.selectAll('.satellite-bg').transition().duration(500).style("opacity", 1);
                oceanRect.transition().duration(500).style("opacity", 0);
                // Make countries slightly transparent to show satellite underneath
                d3.selectAll('.country')
                    .transition()
                    .duration(500)
                    .style("fill-opacity", 0.15)
                    .style("stroke-opacity", 0.6);
                
                // Keep labels visible
                d3.selectAll('.country-label')
                    .transition()
                    .duration(500)
                    .style("opacity", 1);
            } else {
                // Hide all satellite imagery
                d3.selectAll('.satellite-bg').transition().duration(500).style("opacity", 0);
                oceanRect.transition().duration(500).style("opacity", 1);
                // Return countries to normal opacity
                d3.selectAll('.country')
                    .transition()
                    .duration(500)
                    .style("fill-opacity", 1)
                    .style("stroke-opacity", 1);
                
                d3.selectAll('.country-label')
                    .transition()
                    .duration(500)
                    .style("opacity", 0.8);
            }
        });
    </script>
</body>
</html>